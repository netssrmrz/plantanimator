<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Plant Animator - Home</title>
    <style>
      canvas
      {
        border: 4px solid #eee;
        margin-right: 3px;
        padding: 3px;
      }

      #plant_props_div
      {
        display: none;
      }

      #palette_div
      {
        display: none;
      }
    </style>
    <script type="module">
      import * as pl from "./lib/pa.js";

      window.onload = Main;

      function Main()
      {
        document.getElementById("new_plant_btn").onclick=OnClick_New_Plant;
        document.getElementById("edit_plant_btn").onclick=OnClick_Edit_Plant;
        document.getElementById("del_plant_btn").onclick=OnClick_Del_Plants;
        document.getElementById("plant_props_dlg").onclick_new_ok = OnClick_New_Plant_Ok;
        document.getElementById("plant_props_dlg").onclick_edit_ok = OnClick_Edit_Plant_Ok;
        document.getElementById("play_btn").onclick = OnClick_Play;
        document.getElementById("gen_btn").onclick = OnClick_Gen_Code;

        /*New_Plant("Plant_Flower").Render_All();
        New_Plant("Plant_Flower2").Render_All();
        New_Plant("Plant_Flower3").Render_All();
        New_Plant("Plant_Flower4").Render_All();
        New_Plant("Plant_Flower5").Render_All();
        New_Plant("Plant_Flower6").Render_All();
        New_Plant("Plant_Flower7").Render_All();
        New_Plant("Plant_Flower8").Render_All();
        New_Plant("Plant_Flower9").Render_All();
        New_Plant("Plant_Flower10").Render_All();
        New_Plant("Plant_Flower11").Render_All();
        New_Plant("Plant_Flower12").Render_All();
        New_Plant("Plant_Leaf").Render_All();
        New_Plant("Plant_Leaf2").Render_All();
        New_Plant("Plant_Leaf3").Render_All();
        New_Plant("Plant_Leaf4").Render_All();
        New_Plant("Plant_Leaf5").Render_All();
        New_Plant("Plant_Leaf6").Render_All();
        New_Plant("Plant_Leaf7").Render_All();
        New_Plant("Plant_Leaf8").Render_All();
        New_Plant("Plant_Leaf9").Render_All();*/
      }

      function Init_Canvas(class_name)
      {
        const canvas = document.createElement("canvas");
        canvas.id = class_name + "_canvas";
        canvas.width = "200";
        canvas.height = "200";
        document.getElementById("palette_div").appendChild(canvas);

        const canvas_ctx = canvas.getContext("2d");

        canvas_ctx.font = "12px sans-serif";
        canvas_ctx.strokeText(class_name, 10, 20);

        canvas_ctx.strokeStyle = "#aaa";
        canvas_ctx.fillStyle = "#fff";
        canvas_ctx.lineWidth = 4;
        canvas_ctx.lineCap = 'round';
        canvas_ctx.lineJoin = 'round';

        return canvas_ctx;
      }

      /*function New_Plant(class_name)
      {
        var plant = new pl[class_name];
        plant.maturity_rate = 1;
        plant.maturity = 100;
        plant.level = 1;
        plant.canvas_ctx = Init_Canvas(class_name);
        plant.x = 100;
        plant.y = 100;
        plant.x_scale = 1;
        plant.y_scale = -1;
        plant.angle = 0;
        return plant;
      }*/

      // button bar ===============================================================================

      function OnClick_New_Plant()
      {
        const plant = New_Plant();
        document.getElementById("plant_list").Add_Plant(plant);
        document.getElementById("editor_canvas").Render_Plants();
      }

      function OnClick_Edit_Plant()
      {
        const plant_list = document.getElementById("plant_list");
        const dlg = document.getElementById("plant_props_dlg")
        dlg.Edit(plant_list.Get_Selected_Plant());
        dlg.Show();
      }

      function OnClick_Del_Plants()
      {
        const plant_list = document.getElementById("plant_list");
        plant_list.Del_Plants(plant_list.Get_Selected_Plants());
        document.getElementById("editor_canvas").Render_Plants();
      }

      function OnClick_New_Plant_Ok(plant)
      {
        document.getElementById("plant_list").Add_Plant(plant);
        document.getElementById("editor_canvas").Render_Plants();
      }

      function OnClick_Edit_Plant_Ok(plant)
      {
        document.getElementById("plant_list").Edit_Plant(plant);
        document.getElementById("editor_canvas").Render_Plants();
      }
    
      function OnClick_Play()
      {
        document.getElementById("editor_canvas").Play();
      }

      function OnClick_Gen_Code()
      {
        const plants=document.getElementById("plant_list").plants;
        document.getElementById("plant_code_gen").Gen_Scene(plants);
      }

      function New_Plant()
      {
        const class_name = "Plant1";

        const plant = new pl[class_name];
        plant.class_name = class_name;
        plant.name = "Plant 1";
        plant.maturity_rate = 1;
        plant.maturity = 0;
        plant.max_depth = 3;
        plant.x = 500;
        plant.y = 500;
        plant.x_scale = 1;
        plant.y_scale = 1;
        plant.angle = 0;

        return plant;
      }
    </script>

    <!-- Editor_Canvas ============================================================================-->
    <script type="module">
      import {LitElement, html, css} from "./lib/lit-element/lit-element.js";
      import * as pl from "./lib/pa.js";

      const pot_size = 100;

      class Editor_Canvas extends LitElement
      {
        constructor()
        {
          super();
          this.plant_list_id = null;
          this.OnMouseMove_Canvas = this.OnMouseMove_Canvas.bind(this);
          this.OnMouseDown_Canvas = this.OnMouseDown_Canvas.bind(this);
          this.OnMouseUp_Canvas = this.OnMouseUp_Canvas.bind(this);
        }
        
        firstUpdated(changedProperties)
        {
          this.canvas = this.shadowRoot.getElementById("main_canvas");
          this.canvas.addEventListener('mousemove', this.OnMouseMove_Canvas);
          this.canvas.addEventListener('mousedown', this.OnMouseDown_Canvas);
          this.canvas.addEventListener('mouseup', this.OnMouseUp_Canvas);
          this.ctx = this.canvas.getContext("2d");

          if (this.plant_list_id)
          {
            this.plant_list = document.getElementById(this.plant_list_id);
          }
        }

        Init_Btns(plant, sqr_size)
        {
          let btn_size, x, y;

          // scale btn
          if (!plant.scale_btn_path)
          {
            btn_size = 10;
            x = (sqr_size/2)-btn_size;
            y = (sqr_size/2)-btn_size;
            plant.scale_btn_path = new Path2D();
            plant.scale_btn_path.colour = "#f00";
            plant.scale_btn_path.colour_hover = "#0f0";
            plant.scale_btn_path.hover = false;
            plant.scale_btn_path.rect(x, y, btn_size, btn_size);
          }

          // rotate btn
          if (!plant.rotate_btn_path)
          {
            btn_size = 10;
            x = (sqr_size/2)-btn_size;
            y = -(btn_size/2);
            plant.rotate_btn_path = new Path2D();
            plant.rotate_btn_path.colour = "#f00";
            plant.rotate_btn_path.colour_hover = "#0f0";
            plant.rotate_btn_path.hover = false;
            plant.rotate_btn_path.rect(x, y, btn_size, btn_size);
          }

          // translate btn
          if (!plant.move_btn_path)
          {
            btn_size = 10;
            x = -(btn_size/2);
            y = -(btn_size/2);
            plant.move_btn_path = new Path2D();
            plant.move_btn_path.colour = "#f00";
            plant.move_btn_path.colour_hover = "#0f0";
            plant.move_btn_path.hover = false;
            plant.move_btn_path.rect(x, y, btn_size, btn_size);
          }
        }

        Play()
        {
          let plant; 

          if (this.plant_list && this.plant_list.plants.length>0)
          {
            for (let i=0; i<this.plant_list.plants.length; i++)
            {
              plant = this.plant_list.plants[i];
              plant.canvas_ctx = this.ctx;
              plant.Reset();
            }
            pl.Animate(this.ctx, this.plant_list.plants);
          }
        }

        Render_Plants()
        {
          let plant;

          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          if (this.plant_list && this.plant_list.plants.length>0)
          {
            for (let i=0; i<this.plant_list.plants.length; i++)
            {
              plant = this.plant_list.plants[i];
              this.Render_Plant(plant);
            }
          }
        }

        Render_Plant(plant)
        {
          let x, y;
          x = -(pot_size/2);
          y = -(pot_size/2);

          this.Init_Btns(plant, pot_size);

          this.ctx.save();
          this.ctx.translate(plant.x, plant.y);
          this.ctx.rotate(plant.angle);
          this.ctx.scale(plant.x_scale, plant.y_scale);

          this.ctx.strokeRect(x, y, pot_size, pot_size);          

          this.Render_Btn(plant.scale_btn_path);
          this.Render_Btn(plant.rotate_btn_path);
          this.Render_Btn(plant.move_btn_path);

          this.ctx.restore();
        }

        Render_Btn(path)
        {
          if (path.hover)
          {
            this.ctx.fillStyle = path.colour_hover;
          }
          else
          {
            this.ctx.fillStyle = path.colour;
          }

          this.ctx.fill(path);
        }

        OnMouseMove_Canvas(event)
        {
          let plant, do_render;

          plant = this.Get_MouseEvent_Plant(event);
          if (plant)
          {
            do_render = true;
          }

          if (this.move_plant)
          {
            this.move_plant.x = event.offsetX;
            this.move_plant.y = event.offsetY;
            do_render = true;
          }
          if (this.scale_plant)
          {
            const m = new DOMMatrix();
            m.translateSelf(this.scale_plant.x, this.scale_plant.y);
            m.rotateSelf(this.To_Degrees(this.scale_plant.angle));
            m.invertSelf();
            const p = new DOMPoint(event.offsetX, event.offsetY);
            const tp = p.matrixTransform(m);
            this.scale_plant.x_scale = tp.x / (pot_size/2);
            this.scale_plant.y_scale = tp.y / (pot_size/2);
            do_render = true;
          }
          if (this.rotate_plant)
          {
            const x_sign = Math.sign(this.rotate_plant.x_scale);
            const y_sign = Math.sign(this.rotate_plant.y_scale);
            const m = new DOMMatrix();
            m.translateSelf(this.rotate_plant.x, this.rotate_plant.y);
            m.scaleSelf(x_sign, y_sign);
            m.invertSelf();
            const p = new DOMPoint(event.offsetX, event.offsetY);
            const tp = p.matrixTransform(m);
            this.rotate_plant.angle = Math.atan2(tp.y, tp.x) * (x_sign*y_sign);
            do_render = true;
          }

          if (do_render)
          {
            this.Render_Plants();
          }
        }

        To_Degrees(r)
        {
          return r*(180/Math.PI);
        }

        Get_MouseEvent_Plant(event)
        {
          let plant, i, res;

          if (this.plant_list && this.plant_list.plants.length>0)
          {
            for (i=0; i<this.plant_list.plants.length; i++)
            {
              plant = this.plant_list.plants[i];
              this.Set_Plant_MouseEvent(plant, event);
              if (plant.scale_btn_path.hover || plant.rotate_btn_path.hover || plant.move_btn_path.hover)
              {
                res = plant;
                break;
              }
            }
          }

          return res;
        }

        Set_Plant_MouseEvent(plant, event)
        {
          this.ctx.save();
          this.ctx.translate(plant.x, plant.y);
          this.ctx.rotate(plant.angle);
          this.ctx.scale(plant.x_scale, plant.y_scale);
          plant.scale_btn_path.hover = this.ctx.isPointInPath(plant.scale_btn_path, event.offsetX, event.offsetY);
          plant.rotate_btn_path.hover = this.ctx.isPointInPath(plant.rotate_btn_path, event.offsetX, event.offsetY);
          plant.move_btn_path.hover = this.ctx.isPointInPath(plant.move_btn_path, event.offsetX, event.offsetY);
          this.ctx.restore();
        }

        OnMouseDown_Canvas(event)
        {
          let plant;

          plant = this.Get_MouseEvent_Plant(event);
          if (plant && plant.move_btn_path.hover)
          {
            this.move_plant = plant;
          }
          if (plant && plant.scale_btn_path.hover)
          {
            this.scale_plant = plant;
          }
          if (plant && plant.rotate_btn_path.hover)
          {
            this.rotate_plant = plant;
          }
        }

        OnMouseUp_Canvas(event)
        {
          this.move_plant = null;
          this.scale_plant = null;
          this.rotate_plant = null;
        }

        static get properties()
        {
          return {plant_list_id: {type: String}};
        }

        static get styles()
        {
          return css`
            canvas
            {
              border: 4px solid #eee;
              padding: 3px;
            }
          `;
        }

        render()
        {
          return html`<canvas id="main_canvas" width="1000" height="1000"></canvas>`;
        }
      }

      customElements.define('editor-canvas', Editor_Canvas);
    </script>

    <!-- Plant_List ===============================================================================-->
    <script type="module">
      import {LitElement, html, css} from "./lib/lit-element/lit-element.js";

      class Plant_List extends LitElement
      {
        constructor()
        {
          super();
          this.plants = [];
        }

        Get_Selected_Plant()
        {
          let res;

          const checkbox = this.shadowRoot.querySelector("input[type=checkbox]:checked");
          if (checkbox)
          {
            const i = Number.parseInt(checkbox.value);
            res = this.plants[i];
          }

          return res;
        }

        Add_Plant(plant)
        {
          plant.i = this.plants.length;
          this.plants.push(plant);
          this.requestUpdate();
        }

        Edit_Plant(plant)
        {
          this.plants[plant.i] = plant;
          this.requestUpdate();
        }

        render()
        {
          return html`<ul>${this.Render_Items()}</ul>`;
        }

        Render_Items()
        {
          let res = "", plant;

          if (this.plants && this.plants.length>0)
          {
            for (let i=0; i<this.plants.length; i++)
            {
              plant = this.plants[i];
              res = html`${res}${this.Render_Item(i, plant)}`;
            }
          }
          return res;
        }

        Render_Item(i, plant)
        {
          return html`
            <li>
              <input type="checkbox" value="${i}">
              ${plant.name}: x = ${plant.x}, y = ${plant.y}
            </li>
            `;
        }
      }
  
      customElements.define('plant-list', Plant_List);
    </script>

    <!-- Plant_Props_Dialog =======================================================================-->
    <script type="module">
      import {LitElement, html, css} from "./lib/lit-element/lit-element.js";
      import * as pl from "./lib/pa.js";

      class Plant_Props_Dialog extends LitElement 
      {
        constructor()
        {
          super();
        }

        firstUpdated(changedProperties)
        {
          this.plant_name_elem = this.shadowRoot.getElementById("plant_name");
          this.plant_class_elem = this.shadowRoot.getElementById("plant_class");
          this.plant_x_pos_elem = this.shadowRoot.getElementById("plant_x_pos");
          this.plant_y_pos_elem = this.shadowRoot.getElementById("plant_y_pos");
          this.plant_x_scale_elem = this.shadowRoot.getElementById("plant_x_scale");
          this.plant_y_scale_elem = this.shadowRoot.getElementById("plant_y_scale");
          this.plant_angle_elem = this.shadowRoot.getElementById("plant_angle");
          this.new_ok_btn = this.shadowRoot.getElementById("new_plant_ok_btn");
          this.edit_ok_btn = this.shadowRoot.getElementById("edit_plant_ok_btn");
        }

        OnClick_New_Ok()
        {
          var plant = new pl[this.plant_class_elem.value];
          plant.class_name = this.plant_class_elem.value;
          plant.name = this.plant_name_elem.value;
          plant.maturity_rate = 1;
          plant.maturity = 0;
          plant.max_depth = 3;
          plant.x = Number.parseFloat(this.plant_x_pos_elem.value);
          plant.y = Number.parseFloat(this.plant_y_pos_elem.value);
          plant.x_scale = Number.parseFloat(this.plant_x_scale_elem.value);
          plant.y_scale = Number.parseFloat(this.plant_y_scale_elem.value);
          plant.angle = Number.parseFloat(this.plant_angle_elem.value);
          this.Hide();
          this.onclick_new_ok(plant);
        }

        OnClick_Edit_Ok()
        {
          var plant = new pl[this.plant_class_elem.value];
          plant.i = this.plant_i;
          plant.class_name = this.plant_class_elem.value;
          plant.name = this.plant_name_elem.value;
          plant.maturity_rate = 1;
          plant.maturity = 100;
          plant.level = 1;
          //plant.canvas_ctx = Init_Canvas(class_name);
          plant.x = this.plant_x_pos_elem.value;
          plant.y = this.plant_y_pos_elem.value;
          plant.x_scale = this.plant_x_scale_elem.value;
          plant.y_scale = this.plant_y_scale_elem.value;
          plant.angle = this.plant_angle_elem.value;
          this.Hide();
          this.onclick_edit_ok(plant);
        }

        OnClick_Cancel()
        {
          this.Hide();
        }

        New()
        {
          this.plant_name_elem.value = "Plant 1";
          this.plant_class_elem.value = "Plant1";
          this.plant_x_pos_elem.value = "500";
          this.plant_y_pos_elem.value = "500";
          this.plant_x_scale_elem.value = "1";
          this.plant_y_scale_elem.value = "1";
          this.plant_angle_elem.value = "0";
          this.new_ok_btn.hidden = false;
          this.edit_ok_btn.hidden = true;
        }

        Edit(plant)
        {
          this.plant_i = plant.i;
          this.plant_name_elem.value = plant.name;
          this.plant_class_elem.value = plant.class_name;
          this.plant_x_pos_elem.value = plant.x;
          this.plant_y_pos_elem.value = plant.y;
          this.plant_x_scale_elem.value = plant.x_scale;
          this.plant_y_scale_elem.value = plant.y_scale;
          this.plant_angle_elem.value = plant.angle;
          this.new_ok_btn.hidden = true;
          this.edit_ok_btn.hidden = false;
        }

        Hide()
        {
          this.style.display = "none";
        }

        Show()
        {
          this.style.display = "block";
        }

        static get styles()
        {
          return css`
            :host
            {
              display: none;
            }
            `;
        }

        render() 
        {
          return html`
            <div>
              <div>Name</div>
              <div><input id="plant_name" type="text"></div>
            </div>
            <div>
              <div>Class</div>
              <div><input id="plant_class" type="text"></div>
            </div>
            <div>
              <div>X Position</div>
              <div><input id="plant_x_pos" type="number"></div>
            </div>
            <div>
              <div>Y Position</div>
              <div><input id="plant_y_pos" type="number"></div>
            </div>
            <div>
              <div>X Scale</div>
              <div><input id="plant_x_scale" type="number"></div>
            </div>
            <div>
              <div>Y Scale</div>
              <div><input id="plant_y_scale" type="number"></div>
            </div>
            <div>
              <div>Angle</div>
              <div><input id="plant_angle" type="number"></div>
            </div>
            <div>
              <button id="new_plant_ok_btn" @click="${this.OnClick_New_Ok}">Ok</button>
              <button id="edit_plant_ok_btn" @click="${this.OnClick_Edit_Ok}">Ok</button>
              <button id="new_plant_cancel_btn" @click="${this.OnClick_Cancel}">Cancel</button>
            </div>
            `;
        }
      }
  
      customElements.define('plant-props-dlg', Plant_Props_Dialog);
    </script>

    <!-- Plant_Code_Gen ===========================================================================-->
    <script type="module">
      import {LitElement, html, css} from "./lib/lit-element/lit-element.js";

      class Plant_Code_Gen extends LitElement 
      {
        constructor()
        {
          super();
        }

        Gen_Scene(plants)
        {
          let code, plant, array_code;

          if (plants && plants.length>0)
          {
            code = "import * as pl from \"http://localhost:3000/lib/pa.js\";\n";
            for (let i=0; i<plants.length; i++)
            {
              plant = plants[i];
              code += this.Gen_Plant(plant);

              array_code = this.Append_Str(array_code, "plant"+plant.i, ", ");
            }
            code += 
              "\nconst plants=["+array_code+"];\n"+
              "const canvas = document.createElement(\"canvas\");\n" +
              "canvas.width = 1000;\n" +
              "canvas.height = 1000;\n" +
              "document.body.appendChild(canvas);\n" +
              "const ctx = canvas.getContext(\"2d\");\n" +
              "pl.Animate(ctx, plants);\n";
            this.shadowRoot.getElementById("txt_area").value = code;
          }
        }

        Gen_Plant(plant)
        {
          const p = "plant"+plant.i;
          const res = 
            "\nconst "+p+" = new pl."+plant.class_name+"();\n" +
            p+".i = "+plant.i+";\n" +
            p+".class_name = \""+plant.class_name+"\";\n" +
            p+".name = \""+p+"\";\n" +
            p+".maturity_rate = "+plant.maturity_rate+";\n" +
            p+".maturity = 0;\n" +
            p+".max_depth = "+plant.max_depth+";\n" +
            p+".x = "+plant.x+";\n" +
            p+".y = "+plant.y+";\n" +
            p+".x_scale = "+plant.x_scale+";\n" +
            p+".y_scale = "+plant.y_scale+";\n" +
            p+".angle = "+plant.angle+";\n";

          return res;
        }

        Gen_Bud()
        {

        }

        Append_Str(a, b, s)
        {
          let res;

          if (a && b)
          {
            res = a + s + b;
          }
          else if (a && !b)
          {
            res = a;
          }
          else if (!a && b)
          {
            res = b;
          }

          return res;
        }

        OnClick_Run()
        {
          //eval(this.shadowRoot.getElementById("txt_area").value);
          const js = this.shadowRoot.getElementById("txt_area").value;
          const encodedJs = encodeURIComponent(js);
          const dataUri = 'data:text/javascript;charset=utf-8,' + encodedJs;
          import(dataUri);
        }

        render()
        {
          return html`
            <textarea id="txt_area" rows="10" cols="100">yo ho ho</textarea>
            <button @click="${this.OnClick_Run}">Run</button>
          `;
        }
      }
  
      customElements.define('plant-code-gen', Plant_Code_Gen);
    </script>
  </head>

  <body>

    <editor-canvas id="editor_canvas" plant_list_id="plant_list"></editor-canvas>

    <div id="">
      <button id="new_plant_btn">New</button>
      <button id="edit_plant_btn">Edit</button>
      <button id="del_plant_btn">Delete</button>
      <button id="play_btn">Play</button>
      <button id="gen_btn">Generate Code</button>
      <ul></ul>
    </div>

    <plant-list id="plant_list"></plant-list>
    <plant-props-dlg id="plant_props_dlg"></plant-props-dlg>
    <plant-code-gen id="plant_code_gen"></plant-code-gen>

    <div id="palette_div">
    </div>

  </body>
</html>