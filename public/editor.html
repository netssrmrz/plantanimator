<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Plant Animator - Home</title>
    <style>
      h1
      {
        font-family: serif;
        font-style: italic;
        font-size: 40px;
        text-transform: uppercase;
        font-weight: 100;
        margin: 10px;
      }

      body
      {
        text-align: center;
        margin: 0px;
        background-color: #fffff9;
      }

      button
      {
        border-radius: 7px;
        border: 1px solid #000;
        padding: 5px;
        cursor: pointer;
        width: 36px;
        height: 36px;
        background-color: inherit;
      }
      button img
      {
        padding: 0;
        margin: 0;
        width: 24px;
        height: 24px;
      }
      button:disabled
      {
        opacity: 0.25;
      }
    </style>
    <script type="module">
      import * as pl from "./lib/pa.js";

      window.onload = Main;
      let plant_list, editor;

      function Main()
      {
        document.getElementById("new_plant_btn").onclick=OnClick_New_Plant;
        document.getElementById("play_btn").onclick = OnClick_Play;
        document.getElementById("design_btn").onclick = OnClick_Design;
        
        plant_list = document.getElementById("plant_list");
        plant_list.on_change_fn = Plants_OnChange;
        
        editor = document.getElementById("editor_canvas");
        editor.plants = plant_list.plants;
        editor.on_change_fn = Editor_OnChange;
      }

      function Plants_OnChange()
      {
        editor.Render_Plants();
      }

      function Editor_OnChange()
      {
        
      }

      // button bar ===============================================================================

      function OnClick_New_Plant()
      {
        const plant = New_Plant();
        document.getElementById("plant_list").Add_Plant(plant);
        document.getElementById("editor_canvas").Render_Plants();
      }

      function OnClick_New_Plant_Ok(plant)
      {
        document.getElementById("plant_list").Add_Plant(plant);
        document.getElementById("editor_canvas").Render_Plants();
      }
    
      function OnClick_Play()
      {
        const editor = document.getElementById("editor_canvas");

        if (editor.is_playing)
        {
          editor.Stop();
          OnStop_Play();
        }
        else
        {
          editor.Play(OnStop_Play);
          document.getElementById("new_plant_btn").disabled = true;
          document.getElementById("design_btn").disabled = true;
          document.getElementById("plant_list").Set_Disabled(true);
        }
      }

      function OnStop_Play()
      {
        document.getElementById("new_plant_btn").disabled = false;
        document.getElementById("design_btn").disabled = false;
        document.getElementById("plant_list").Set_Disabled(false);
      }

      function OnClick_Design()
      {
        document.getElementById("editor_canvas").Render_Plants();
      }

      function New_Plant()
      {
        const class_name = "Plant1";

        const plant = new pl[class_name];
        plant.class_name = class_name;
        plant.name = "Plant 1";
        plant.maturity_rate = 1;
        plant.maturity = 0;
        plant.max_depth = 3;
        plant.x = 500;
        plant.y = 500;
        plant.x_scale = 1;
        plant.y_scale = 1;
        plant.angle = 0;

        return plant;
      }
    </script>

    <!-- Editor_Canvas ============================================================================-->
    <script type="module">
      import {LitElement, html, css} from "./lib/lit-element/lit-element.js";
      import * as pl from "./lib/pa.js";

      const pot_size = 100;

      class Editor_Canvas extends LitElement
      {
        constructor()
        {
          super();
          this.plants = null;
          this.OnMouseMove_Canvas = this.OnMouseMove_Canvas.bind(this);
          this.OnMouseDown_Canvas = this.OnMouseDown_Canvas.bind(this);
          this.OnMouseUp_Canvas = this.OnMouseUp_Canvas.bind(this);
          this.Render_Plants = this.Render_Plants.bind(this);
          this.OnFinish_Play = this.OnFinish_Play.bind(this);
          this.is_playing = false;
          this.on_finish_play_fn = null;
          this.colour = "#000";
          this.colour_selected = "#0f0";
        }
        
        firstUpdated(changedProperties)
        {
          this.canvas = this.shadowRoot.getElementById("main_canvas");
          this.canvas.addEventListener('mousemove', this.OnMouseMove_Canvas);
          this.canvas.addEventListener('mousedown', this.OnMouseDown_Canvas);
          this.canvas.addEventListener('mouseup', this.OnMouseUp_Canvas);
          this.ctx = this.canvas.getContext("2d");
        }

        Init_Btns(plant, sqr_size)
        {
          let btn_size, x, y;

          // scale btn
          if (!plant.scale_btn_path)
          {
            btn_size = 10;
            x = (sqr_size/2)-btn_size;
            y = (sqr_size/2)-btn_size;
            plant.scale_btn_path = new Path2D();
            plant.scale_btn_path.colour = "#f00";
            plant.scale_btn_path.colour_hover = "#0f0";
            plant.scale_btn_path.hover = false;
            plant.scale_btn_path.rect(x, y, btn_size, btn_size);
          }

          // rotate btn
          if (!plant.rotate_btn_path)
          {
            btn_size = 10;
            x = (sqr_size/2)-btn_size;
            y = -(btn_size/2);
            plant.rotate_btn_path = new Path2D();
            plant.rotate_btn_path.colour = "#f00";
            plant.rotate_btn_path.colour_hover = "#0f0";
            plant.rotate_btn_path.hover = false;
            plant.rotate_btn_path.rect(x, y, btn_size, btn_size);
          }

          // translate btn
          if (!plant.move_btn_path)
          {
            btn_size = 10;
            x = -(btn_size/2);
            y = -(btn_size/2);
            plant.move_btn_path = new Path2D();
            plant.move_btn_path.colour = "#f00";
            plant.move_btn_path.colour_hover = "#0f0";
            plant.move_btn_path.hover = false;
            plant.move_btn_path.rect(x, y, btn_size, btn_size);
          }
        }

        Play(on_finish_play_fn)
        {
          let plant; 

          if (this.plants && this.plants.length>0)
          {
            for (let i=0; i<this.plants.length; i++)
            {
              plant = this.plants[i];
              plant.canvas_ctx = this.ctx;
              plant.Reset();
            }
            this.is_playing = true;
            this.on_finish_play_fn = on_finish_play_fn;
            pl.Animate(this.ctx, this.plants, this.OnFinish_Play, this.Render_Plants);
          }
        }

        OnFinish_Play()
        {
          this.is_playing = false;
          if (this.on_finish_play_fn)
          {
            this.on_finish_play_fn();
          }
        }

        Stop()
        {
          if (this.is_playing)
          {
            this.ctx.stop = true;
            this.is_playing = false;
          }
        }

        Render_Plants()
        {
          let plant;

          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          if (this.plants && this.plants.length>0)
          {
            for (let i=0; i<this.plants.length; i++)
            {
              plant = this.plants[i];
              this.Render_Plant(plant);
            }
          }
        }

        Render_Plant(plant)
        {
          let x, y;
          x = -(pot_size/2);
          y = -(pot_size/2);

          this.Init_Btns(plant, pot_size);

          this.ctx.save();
          this.ctx.translate(plant.x, plant.y);
          this.ctx.rotate(plant.angle);
          this.ctx.scale(plant.x_scale, plant.y_scale);

          if (plant.selected)
          {
            this.ctx.strokeStyle = this.colour_selected;
          }
          else
          {
            this.ctx.strokeStyle = this.colour;
          }
          this.ctx.strokeRect(x, y, pot_size, pot_size);          

          this.Render_Btn(plant.scale_btn_path);
          this.Render_Btn(plant.rotate_btn_path);
          this.Render_Btn(plant.move_btn_path);

          this.ctx.restore();
        }

        Render_Btn(path)
        {
          if (path.hover)
          {
            this.ctx.fillStyle = path.colour_hover;
          }
          else
          {
            this.ctx.fillStyle = path.colour;
          }

          this.ctx.fill(path);
        }

        OnMouseMove_Canvas(event)
        {
          let plant, do_render;

          plant = this.Get_MouseEvent_Plant(event);
          if (plant)
          {
            do_render = true;
          }

          if (this.move_plant)
          {
            this.move_plant.x = event.offsetX;
            this.move_plant.y = event.offsetY;
            do_render = true;
          }
          if (this.scale_plant)
          {
            const m = new DOMMatrix();
            m.translateSelf(this.scale_plant.x, this.scale_plant.y);
            m.rotateSelf(this.To_Degrees(this.scale_plant.angle));
            m.invertSelf();
            const p = new DOMPoint(event.offsetX, event.offsetY);
            const tp = p.matrixTransform(m);
            this.scale_plant.x_scale = tp.x / (pot_size/2);
            this.scale_plant.y_scale = tp.y / (pot_size/2);
            do_render = true;
          }
          if (this.rotate_plant)
          {
            const x_sign = Math.sign(this.rotate_plant.x_scale);
            const y_sign = Math.sign(this.rotate_plant.y_scale);
            const m = new DOMMatrix();
            m.translateSelf(this.rotate_plant.x, this.rotate_plant.y);
            m.scaleSelf(x_sign, y_sign);
            m.invertSelf();
            const p = new DOMPoint(event.offsetX, event.offsetY);
            const tp = p.matrixTransform(m);
            this.rotate_plant.angle = Math.atan2(tp.y, tp.x) * (x_sign*y_sign);
            do_render = true;
          }

          if (do_render)
          {
            this.Render_Plants();
          }
        }

        To_Degrees(r)
        {
          return r*(180/Math.PI);
        }

        Get_MouseEvent_Plant(event)
        {
          let plant, i, res;

          if (this.plants && this.plants.length>0)
          {
            for (i=0; i<this.plants.length; i++)
            {
              plant = this.plants[i];
              this.Set_Plant_MouseEvent(plant, event);
              if (plant.scale_btn_path.hover || plant.rotate_btn_path.hover || plant.move_btn_path.hover)
              {
                res = plant;
                break;
              }
            }
          }

          return res;
        }

        Set_Plant_MouseEvent(plant, event)
        {
          this.ctx.save();
          this.ctx.translate(plant.x, plant.y);
          this.ctx.rotate(plant.angle);
          this.ctx.scale(plant.x_scale, plant.y_scale);
          plant.scale_btn_path.hover = this.ctx.isPointInPath(plant.scale_btn_path, event.offsetX, event.offsetY);
          plant.rotate_btn_path.hover = this.ctx.isPointInPath(plant.rotate_btn_path, event.offsetX, event.offsetY);
          plant.move_btn_path.hover = this.ctx.isPointInPath(plant.move_btn_path, event.offsetX, event.offsetY);
          this.ctx.restore();
        }

        OnMouseDown_Canvas(event)
        {
          let plant;

          plant = this.Get_MouseEvent_Plant(event);
          if (plant && plant.move_btn_path.hover)
          {
            this.move_plant = plant;
          }
          if (plant && plant.scale_btn_path.hover)
          {
            this.scale_plant = plant;
          }
          if (plant && plant.rotate_btn_path.hover)
          {
            this.rotate_plant = plant;
          }

          /*if (this.plant_list)
          {
            this.plant_list.Select_Plant(plant);
          }*/
        }

        OnMouseUp_Canvas(event)
        {
          this.move_plant = null;
          this.scale_plant = null;
          this.rotate_plant = null;
        }

        static get properties()
        {
          return {plant_list_id: {type: String}};
        }

        static get styles()
        {
          return css`
            canvas
            {
              border: 0;
              box-shadow: 
                0px 0px 0px 1px rgb(0,0,0), 
                0px 0px 0px 4px rgb(255, 255, 255), 
                0px 0px 0px 7px rgb(0, 0, 0);
              margin: 7px;
              padding: 3px;      
            }
          `;
        }

        render()
        {
          return html`<canvas id="main_canvas" width="1000" height="1000"></canvas>`;
        }
      }

      customElements.define('editor-canvas', Editor_Canvas);
    </script>

    <!-- Plant_List ===============================================================================-->
    <script type="module">
      import {LitElement, html, css} from "./lib/lit-element/lit-element.js";
      import "./lib/Plant_Props_Dialog.js";
      import "./lib/Plant_Code_Gen.js";

      class Plant_List extends LitElement
      {
        constructor()
        {
          super();
          this.plants = [];
          this.on_change_fn = null;
          this.OnClick_Edit_Ok = this.OnClick_Edit_Ok.bind(this);
        }
        
        firstUpdated(changedProperties)
        {
          const dlg = this.shadowRoot.getElementById("dlg");
          
          dlg.onclick_edit_ok = this.OnClick_Edit_Ok;
        }

        Get_Selected_Plant()
        {
          let res;

          const checkbox = this.shadowRoot.querySelector("input[type=checkbox]:checked");
          if (checkbox)
          {
            const i = Number.parseInt(checkbox.value);
            res = this.plants[i];
          }

          return res;
        }

        Set_Disabled(disabled)
        {
          let btns, i;

          btns = this.shadowRoot.querySelectorAll("button");
          if (btns && btns.length>0)
          {
            btns.forEach((btn) => btn.disabled = disabled);
          }
        }

        Add_Plant(plant)
        {
          plant.id = this.plants.length;
          this.plants.push(plant);
          this.requestUpdate();
        }

        Edit_Plant(plant)
        {
          const i = this.Get_Plant_Idx(plant);
          this.plants[i] = plant;
          this.requestUpdate();
        }

        Select_Plant(plant_id)
        {
          let plant;

          if (this.plants && this.plants.length>0)
          {
            for (let i=0; i<this.plants.length; i++)
            {
              plant = this.plants[i];
              plant.selected = false;
              if (plant.id == plant_id)
              {
                plant.selected = true;
              }
            }
            this.requestUpdate();
            if (this.on_change_fn)
              this.on_change_fn();
          }
        }

        Delete_Plant(plant_id)
        {
          const msg = "Are you sure you want to delete this plant?";
          let i;

          if (confirm(msg))
          {
            i = this.Get_Plant_Idx(plant_id);
            this.plants.splice(i, 1);
            if (this.on_change_fn)
              this.on_change_fn();
            this.requestUpdate();
          }
        }

        Get_Plant_Idx(plant_id)
        {
          let res = null;

          if (this.plants && this.plants.length>0)
          {
            for (let i=0; i<this.plants.length; i++)
            {
              if (this.plants[i].id == plant_id)
              {
                res = i;
                break;
              }
            }
          }

          return res;
        }

        OnClick_Delete_Plant(event)
        {
          const plant_id = event.currentTarget.getAttribute("plant-id");
          this.Delete_Plant(plant_id);
        }

        OnClick_Select_Plant(event)
        {
          const plant_id = event.currentTarget.getAttribute("plant-id");
          this.Select_Plant(plant_id);
        }

        OnClick_Edit_Plant(event)
        {
          const dlg = this.shadowRoot.getElementById("dlg");
          const id = event.currentTarget.getAttribute("plant-id");
          const i = this.Get_Plant_Idx(id);
          const plant = this.plants[i];

          dlg.Show();
          dlg.Edit(plant);
        }

        OnClick_Edit_Ok(plant)
        {
          const i = this.Get_Plant_Idx(plant.id);
          this.plants[i] = plant;
          this.requestUpdate();
          if (this.on_change_fn)
            this.on_change_fn();
        }

        OnClick_Gen_Code()
        {
          const code = this.shadowRoot.getElementById("code");
          code.Show();
          code.Gen_Scene(this.plants);
        }

        static get styles()
        {
          return css`
            :host
            {
              display: block;  
              margin-top: 20px;
            }
            table
            {
              border-collapse: collapse;
              margin-left:auto; 
              margin-right:auto;
            }
            thead
            {
              box-shadow: 
                rgb(0,0,0) 0px 1px 0px 0px, 
                rgb(255,255,255) 0px 4px 0px 0px, 
                rgb(0,0,0) 0px 7px 0px 0px;            
            }
            tbody:before
            {
              display: block;
              content: " ";
              height: 20px;
            }
            tbody tr:hover
            {
              background-color: #ddd;
              cursor: pointer;
            }
            th
            {
              font-weight: 100;
              font-family: serif;
              font-style: italic;
              font-size: 20px;
              xtext-transform: uppercase;
              padding: 0px 10px;
            }
            td
            {
              padding: 4px 12px;
              font-family: monospace;
              font-size: 16px;
            }
            #btn_bar
            {
              text-align: left;
            }
            button
            {
              border-radius: 7px;
              border: 1px solid #000;
              padding: 5px;
              cursor: pointer;
              width: 36px;
              height: 36px;
              background-color: inherit;
            }
            button:disabled
            {
              opacity: 0.25;
            }
            button img
            {
              padding: 0;
              margin: 0;
              width: 24px;
              height: 24px;
            }
            .selected
            {
              background-color: #0f0;
            }
          `;
        }

        render()
        {
          return html`
            <table>
              <thead>
                <tr>
                  <th>Actions</th>
                  <th>#</th>
                  <th>Name</th>
                  <th>Class</th>
                  <th>X</th>
                  <th>Y</th>
                  <th>X Scale</th>
                  <th>Y Scale</th>
                  <th>Angle</th>
                </tr>
              </thead>
              <tbody>
                ${this.Render_Items()}
              </tbody>
              <tfoot>
                <tr>
                  <td id="btn_bar" colspan="9">
                    <button id="gen_btn" @click="${this.OnClick_Gen_Code}"><img src="images/code-json.svg"></button>
                  </td>
                </tr>
              </tfoot>
            </table>
            <plant-props-dlg id="dlg"></plant-props-dlg>
            <plant-code-gen id="code"></plant-code-gen>
          `;
        }

        Render_Items()
        {
          let res = "", plant;

          if (this.plants && this.plants.length>0)
          {
            for (let i=0; i<this.plants.length; i++)
            {
              plant = this.plants[i];
              res = html`${res}${this.Render_Item(i, plant)}`;
            }
          }
          return res;
        }

        Render_Item(i, plant)
        {
          let row_class = "";

          if (plant.selected)
          {
            row_class = "selected";
          }

          return html`
            <tr plant-id="${plant.id}" class="${row_class}">
              <td>
                <button plant-id="${plant.id}" @click="${this.OnClick_Select_Plant}"><img src="images/target.svg"></button>
                <button plant-id="${plant.id}" @click="${this.OnClick_Edit_Plant}"><img src="images/pencil-outline.svg"></button>
                <button plant-id="${plant.id}" @click="${this.OnClick_Delete_Plant}"><img src="images/delete-outline.svg"></button>
              </td>
              <td>${i+1}</td>
              <td>${plant.name}</td>
              <td>${plant.class_name}</td>
              <td>${plant.x}</td>
              <td>${plant.y}</td>
              <td>${plant.x_scale}</td>
              <td>${plant.y_scale}</td>
              <td>${plant.angle}</td>
            </tr>
            `;
        }
      }
  
      customElements.define('plant-list', Plant_List);
    </script>
  </head>

  <body>
    <h1>Plantinator</h1>

    <editor-canvas id="editor_canvas" plant_list_id="plant_list"></editor-canvas>

    <div>
      <button id="new_plant_btn"><img src="images/plus.svg"></button>
      <button id="play_btn"><img src="images/play-pause.svg"></button>
      <button id="design_btn"><img src="images/pencil-ruler.svg"></button>
    </div>

    <plant-list id="plant_list"></plant-list>

  </body>
</html>