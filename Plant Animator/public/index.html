<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8" />
    <title>Plant Animator</title>
    <style>
      #canvas
      {
        border: solid 1px #f00;
      }
      </style>
    <script>
      window.onload = Main;

      class Plant
      {
        constructor()
        {
          this.maturity = 0;
        }

        Animate()
        {
          Plant_Animate.plant = this;
          Plant_Animate();
        }

        Next_Frame()
        {
          let res = false;

          this.canvas_ctx.clearRect(0, 0, this.canvas_ctx.canvas.width, this.canvas_ctx.canvas.height);
          this.Render_All();
          res = this.Grow_All();

          return res;
        }

        Grow_All()
        {
          var res = false, branch_res;

          if (this.maturity < 1)
          {
            this.maturity += this.maturity_rate;
            if (this.maturity > 1)
              this.maturity = 1;

            this.Grow();
            res = true;
          }

          if (this.branches)
            for (var c = 0; c < this.branches.length; c++)
            {
              branch_res = this.branches[c].Grow_All();
              res = res || branch_res;
            }

          return res;
        }

        Render_All()
        {
          var branch;

          this.canvas_ctx.save();
          this.canvas_ctx.translate(this.x, this.y);
          this.canvas_ctx.rotate(this.angle);
          this.canvas_ctx.scale(this.scale, this.scale);

          this.Render();
          if (this.branches)
            for (var c = 0; c < this.branches.length; c++)
            {
              branch = this.branches[c];
              branch.Render_All();
            }

          this.canvas_ctx.restore();
        }

        Add_Branch(plant)
        {
          if (!this.branches)
            this.branches = [];
          this.branches.push(plant);
        }

        Equal(a, b)
        {
          return Math.abs(a - b) <= Number.EPSILON;
        }

        Dump(level)
        {
          let res = "";

          res = JSON.stringify(this).padStart(res.length + level, "&nbsp;") + "<br>";

          //if (this.branches)
          //for (var c = 0; c < this.branches.length; c++)
          //res = res + this.branches[c].Dump(level + 1);

          return res;
        }

        Grow()
        {
          if (this.Equal(this.maturity, 0.1) && this.level > 0)
          {
            const size = 100 * this.maturity;
            const plant = new Plant();
            plant.x = size;
            plant.y = size;
            plant.angle = 1;
            plant.maturity_rate = 0.01;
            plant.level = this.level - 1;
            plant.scale = 0.5;
            plant.canvas_ctx = this.canvas_ctx;
            this.Add_Branch(plant);
          }
        }

        Render()
        {
          const size = 100 * this.maturity;
          //const x1 = this.x - size * 0.5;
          //const y1 = this.y - size * 0.5;
          this.canvas_ctx.moveTo(0, 0)
          this.canvas_ctx.lineTo(size, size);
          this.canvas_ctx.stroke();
        }
      }

      function Plant_Animate()
      {
        document.getElementById("log").innerHTML = Plant_Animate.plant.Dump(0);
        if (Plant_Animate.plant.Next_Frame())
          window.requestAnimationFrame(Plant_Animate);
      };

      function Main() 
      {
        let plant, canvas, canvas_ctx;

        canvas = document.getElementById("canvas");
        canvas_ctx = canvas.getContext("2d", { alpha: false });
        canvas_ctx.fillStyle = "green";
        canvas_ctx.strokeStyle = "green";

        plant = new Plant();
        plant.x = 160;
        plant.y = 120;
        plant.angle = 0;
        plant.maturity_rate = 0.01;
        plant.level = 4;
        plant.scale = 1;
        plant.canvas_ctx = canvas_ctx;
        plant.Animate();
      }
      </script>
    </head>

  <body>
    <div>Plant Animator</div>
    <canvas id="canvas" width="640" height="480"></canvas>
    <div id="log"></div>
  </body>

  </html>