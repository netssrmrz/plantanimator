<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Plant Animator</title>
  <style>
    html, body
    {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #fff;
    }

    #canvas
    {
      width: 100%;
      height: 100%;
      z-index: 0;
      position: absolute;
      left: 0px;
      top: 0px;
    }

    #title
    {
      width: 1000px;
      height: 100px;
      text-align: center;
      font-size: 60px;
      color: #aaa;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: auto;
    }
  </style>
  <script type="module">
    import { Plant_Maturing, Animate } from "./lib/pa.js";
    import { Bezier } from "./lib/bezierjs/bezier.js";

    window.onload = Main;
    function Main()
    {
      var c, plant, plants, canvas, canvas_ctx;

      canvas = document.getElementById("canvas");
      canvas_ctx = canvas.getContext("2d");
      canvas_ctx.strokeStyle = "#aaa";
      canvas_ctx.fillStyle = "#fff";
      canvas_ctx.lineWidth = 4;
      canvas_ctx.lineCap = 'round';

      plants = [];
      plants.push(New_Top_Border(canvas_ctx));
      plants.push(New_Left_Border(canvas_ctx));
      plants.push(New_Bottom_Border(canvas_ctx));
      plants.push(New_Right_Border(canvas_ctx));

      Animate(canvas_ctx, plants);
    }

    function New_Top_Border(canvas_ctx)
    {
      var plant = new Plant_Stem();
      plant.maturity_rate = 0.25;
      plant.level = 3;
      plant.canvas_ctx = canvas_ctx;
      plant.x = 0;
      plant.y = 0;
      plant.x_scale = 1;
      plant.y_scale = -1;
      plant.angle = 0.14;
      return plant;
    }

    function New_Bottom_Border(canvas_ctx)
    {
      var plant = new Plant_Stem();
      plant.maturity_rate = 0.25;
      plant.level = 3;
      plant.canvas_ctx = canvas_ctx;
      plant.x = 2000;
      plant.y = 1000;
      plant.x_scale = -1;
      plant.y_scale = 1;
      plant.angle = 0.14;
      return plant;
    }

    function New_Left_Border(canvas_ctx)
    {
      var plant = new Plant_Stem();
      plant.maturity_rate = 0.25;
      plant.level = 4;
      plant.canvas_ctx = canvas_ctx;
      plant.x = 0;
      plant.y = 0;
      plant.x_scale = -1;
      plant.y_scale = -1;
      plant.angle = -1.7;
      return plant;
    }

    function New_Right_Border(canvas_ctx)
    {
      var plant = new Plant_Stem();
      plant.maturity_rate = 0.25;
      plant.level = 4;
      plant.canvas_ctx = canvas_ctx;
      plant.x = 2000;
      plant.y = 1000;
      plant.x_scale = 1;
      plant.y_scale = 1;
      plant.angle = -1.7;
      return plant;
    }

    function Random(base, delta)
    {
      return base + (Math.random() - 0.5) * delta;
    }

    class Plant_Flower extends Plant_Maturing
    {
      Render()
      {
        var c, p = 4;

        this.canvas_ctx.lineWidth = 2;
        this.canvas_ctx.beginPath();
        for (c = 0; c < p; c++)
        {
          this.canvas_ctx.moveTo(0, 0);
          this.canvas_ctx.bezierCurveTo(this.maturity / 4, this.maturity / 4, this.maturity / 4, -this.maturity / 4, 0, 0);
          this.canvas_ctx.rotate(2 * Math.PI / p);
        }
        this.canvas_ctx.fill();
        this.canvas_ctx.stroke();
      }
    }

    class Plant_Leaf extends Plant_Maturing
    {
      Render()
      {
        this.canvas_ctx.lineWidth = 2;
        this.canvas_ctx.beginPath();
        this.canvas_ctx.moveTo(0, 0);
        this.canvas_ctx.quadraticCurveTo(this.maturity / 4, this.maturity / 4, 0, this.maturity / 2);
        this.canvas_ctx.quadraticCurveTo(-this.maturity / 4, this.maturity / 4, 0, 0);
        this.canvas_ctx.fill();
        this.canvas_ctx.stroke();
      }
    }

    class Plant_Stem extends Plant_Maturing
    {
      constructor()
      {
        var x1, y1, x2, y2, cx1, cy1, cx2, cy2;

        super();

        x1 = 0; y1 = 0;
        x2 = 1000; y2 = 0;

        cx1 = 200; cy1 = -250;
        cx2 = 800; cy2 = 250;

        this.curve = new Bezier(
          x1, y1, cx1, cy1,
          cx2, cy2, x2, y2);
        this.curve_pts = this.curve.getLUT(100);
      }

      Render()
      {
        var c;

        for (c = 1; c < this.maturity; c++)
        {
          this.canvas_ctx.beginPath();
          this.canvas_ctx.lineWidth = (this.maturity - c) / 10;
          this.canvas_ctx.moveTo(this.curve_pts[c - 1].x, this.curve_pts[c - 1].y);
          this.canvas_ctx.lineTo(this.curve_pts[c].x, this.curve_pts[c].y);
          this.canvas_ctx.stroke();
        }
      }

      Grow_Maturing()
      {
        if (this.curr_level < this.level)
        {
          if (this.maturity >= 10 && !this.branches)
            this.Add_Stem(Random(0, 0.5), 0.5, -0.5);

          if (this.maturity >= 20 && this.branches.length == 1)
            this.Add_Leaf(Random(4.7, 1));

          if (this.maturity >= 50 && this.branches.length == 2)
            this.Add_Stem(Random(0, 0.5), 0.25, 0.25);

          if (this.maturity >= 90 && this.branches.length == 3)
            this.Add_Flower(Random(0, 2));
        }
      }

      Add_Flower(angle)
      {
        const plant = new Plant_Flower();
        this.Add_Plant(angle, plant, 1 / this.Total_X_Scale(), 1 / this.Total_Y_Scale());
      }

      Add_Leaf(angle)
      {
        const plant = new Plant_Leaf();
        this.Add_Plant(angle, plant, 1 / this.Total_X_Scale(), 1 / this.Total_Y_Scale());
      }

      Add_Stem(angle, x_scale, y_scale)
      {
        const plant = new Plant_Stem();
        this.Add_Plant(angle, plant, x_scale, y_scale);
      }

      Add_Plant(angle, plant, x_scale, y_scale)
      {
        plant.x = this.curve_pts[Math.trunc(this.maturity)].x;
        plant.y = this.curve_pts[Math.trunc(this.maturity)].y;
        plant.x_scale = x_scale;
        plant.y_scale = y_scale;
        plant.angle = angle;
        plant.maturity_rate = this.maturity_rate;
        this.Add_Branch(plant);
      }
    }

  </script>
  <script>
  </script>
</head>

<body>
  <div id="title">Floral Animation - Sample 1</div>
  <canvas id="canvas" width="2000" height="1000"></canvas>
</body>

  </html>